/*!
  Calefactor
  Copyright (C) 2015 Calefactor Contributors

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
var Artist;Artist=function(){function a(a,b){this.canvas=a,this.ctx=b}return a.prototype.clear=function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},a.prototype.image=function(a,b,c,d){return d&&(this.ctx.save(),this.ctx.scale(-1,0)),this.ctx.drawImage(this.game.gameMediaManager.images[a],b,c),d?this.ctx.restore():void 0},a}();var Game;Game=function(){function a(a){var b;for(b in a)this[b]=a[b];if(this.canvasSelector&&(this.canvas=document.querySelector(this.canvasSelector)),!this.canvas)throw new GameInitializationError("The canvas was not created.");this.initCanvas(),this.gameMediaManager=new GameMediaManager(this(function(){return this.gameLevelManager=new GameLevelManager(this(function(){return this.gameRenderer=new GameRenderer(this),this.gameKeybindingManager=new GameKeybindingManager(this),this.gameLevelManager.levels[this.level].initialize(),this.startLoop()}))}))}return a.prototype.initCanvas=function(){return this.canvas.width=this.width,this.canvas.height=this.height,this.graphicsContext=this.canvas.getContext("2d"),this.graphicsContext.transform(-1,0,0,1,this.canvas.height,0),this.artist=new Artist(this.canvas,this.grapicsContext)},a.prototype.startLoop=function(){return this.loops=0,this.skipTicks=1e3/this.fps,this.maxSkip=10,this.nextTick=(new Date).getTime(),requestAnimationFrame(this.animationFrame)},a.prototype.animationFrame=function(){for(this.loops=0;(new Date).getTime()>this.nextTick&&this.loops<this.maxSkip;)this.gameLeveManager.levels[this.level].update(),this.nextTick+=this.skipTicks,this.loops++;return this.gameRenderer.render(),this.gameLevelManager.levels[this.level].music&&this.gameMediaManager.audio[this.gameLevelManager.levels[this.level].music].play(),requestAnimationFrame(this.animationFrame)},a.prototype.playAudio=function(a){return this.gameMediaManager.audio[a].play()},a.prototype.changeLevels=function(a){return this.stopMusic(),this.level=a,this.gameLevelManager.levels[a].initialize()},a.prototype.stopMusic=function(){var a,b;b=[];for(a in this.gameMediaManager.audio)this.gameMediaManager.audio[a].pause(),b.push(this.gameMediaManager.audio[a].currentTime=0);return b},a.prototype.name="The game",a.prototype.canvas=null,a.prototype.canvasSelector=null,a.prototype.graphicsContext=null,a.prototype.width=500,a.prototype.height=500,a.prototype.fps=60,a.prototype.audioNeeded=[],a.prototype.imagesNeeded=[],a.prototype.levelsNeeded=[],a.prototype.level=0,a.prototype.keybindings={},a}();var GameError,GameInitializationError,extend=function(a,b){function c(){this.constructor=a}for(var d in b)hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},hasProp={}.hasOwnProperty;GameError=function(a){function b(a){this.message=a}return extend(b,a),b.prototype.message="There was an error.",b.prototype.name="GameError",b}(Error),GameInitializationError=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return extend(b,a),b.prototype.name="GameInitializationError",b}(GameError);var GameRenderer;GameRenderer=function(){function a(a){this.game=a}return a.prototype.render=function(){var a,b,c,d,e;for(this.game.artist.clear(),a=this.game.gameLevelManager.levels[this.game.level].objects,e=[],c=0,d=a.length;d>c;c++)b=a[c],a[b].image&&this.game.artist.image(a[b].image,a[b].x,a[b].y,a[b].flipImage),a[b].render?e.push(a[b].render()):e.push(void 0);return e},a}();var Level;Level=function(){function a(a,b,c){var d,e;this.game=a,e=this,d=new XMLHttpRequest,d.onload=function(){return e.parse(this.responseText(c))},d.open("get",b,!0),d.send()}return a.prototype.parse=function(a,b){return this.jsondata=JSON.parse(a),this.name=this.jsondata.name,this.music=this.jsondata.music,b()},a.prototype.initialize=function(){var a,b,c,d,e,f;for(this.objects=[],d=this.jsondata.objects,e=[],b=0,c=d.length;c>b;b++)a=d[b],f=this.jsondata.objects[a].split(":"),e.push(this.objects[a]=new window[f[0]+"Object"](parseInt(f[1],parseInt(f[2],parseInt(f[3])))));return e},a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j;for(h=this.objects,j=[],d=0,f=h.length;f>d;d++)if(b=h[d],this.objects[b].update){for(a=[],i=this.objects,e=0,g=i.length;g>e;e++)c=i[e],this.checkIntersections(this.objects[b],this.objects[c])&&collisons.push(c);j.push(this.objects[b].update(a))}else j.push(void 0);return j},a.prototype.checkIntersections=function(a,b){return!(b.x>a.x+a.width||b.x+b.width<a.x||b.y+b.height>a.y||b.y<a.y+a.height)},a}();var Object;Object=function(){function a(a,b,c,d){this.game=a,this.x=null!=b?b:0,this.y=null!=c?c:0,this.datavalue=null!=d?d:0,this.initialize()}return a.prototype.width=0,a.prototype.height=0,a}();